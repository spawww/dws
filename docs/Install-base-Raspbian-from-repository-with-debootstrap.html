<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>

    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Install base Raspbian from repository with debootstrap</title>
  </head>
  <body>
    <h1 itemprop="name" class="fs-headline1 ow-break-word mb8 grid--cell
      fl1"><a
data-savepage-href="/questions/78232/install-base-raspbian-from-repository-not-using-an-image"
href="https://raspberrypi.stackexchange.com/questions/78232/install-base-raspbian-from-repository-not-using-an-image"
        class="question-hyperlink">Install base Raspbian from
        repository, not using an image</a></h1>
    <div class="ml12 aside-cta grid--cell print:d-none sm:ml0 sm:mb12
      sm:order-first sm:as-end"> </div>
    <div class="grid fw-wrap pb8 mb16 bb bc-black-075">
      <div class="grid--cell ws-nowrap mr16 mb8" title="2018-01-23
        21:13:22Z"> <span class="fc-light mr2">Asked</span> <time
          itemprop="dateCreated" datetime="2018-01-23T21:13:22">3 years,
          2 months ago</time> </div>
      <div class="grid--cell ws-nowrap mr16 mb8"> <span class="fc-light
          mr2">Active</span> <a data-savepage-href="?lastactivity"
href="https://raspberrypi.stackexchange.com/questions/78232/install-base-raspbian-from-repository-not-using-an-image?lastactivity"
          class="s-link s-link__inherit" title="2020-05-11 16:28:42Z">10
          months ago</a> </div>
      <div class="grid--cell ws-nowrap mb8" title="Viewed 5,102 times">
        <span class="fc-light mr2">Viewed</span> 5k times </div>
    </div>
    <div id="mainbar" role="main" aria-label="question and answers">
      <div class="question" data-questionid="78232" data-ownerid="79866"
        data-score="6" id="question">
        <div class="js-zone-container zone-container-main"> </div>
        <div class="post-layout">
          <div class="votecell post-layout--left">
            <div class="js-voting-container grid jc-center fd-column
              ai-stretch gs4 fc-black-200" data-post-id="78232"> <br>
            </div>
          </div>
        </div>
      </div>
    </div>
    <a class="js-post-issue grid--cell s-btn s-btn__unset c-pointer py6
      mx-auto" data-savepage-href="/posts/78232/timeline"
      href="https://raspberrypi.stackexchange.com/posts/78232/timeline"
      data-shortcut="T" data-ks-title="timeline"
      data-controller="s-tooltip" data-s-tooltip-placement="right"
      aria-label="Timeline"
      aria-describedby="--stacks-s-tooltip-pqged9n4"></a>
    <div class="question" data-questionid="78232" data-ownerid="79866"
      data-score="6" id="question">
      <div class="post-layout">
        <div class="votecell post-layout--left">
          <div class="js-voting-container grid jc-center fd-column
            ai-stretch gs4 fc-black-200" data-post-id="78232">
          </div>
        </div>
        <div class="postcell post-layout--right">
          <div class="s-prose js-post-body" itemprop="text">
            <p>Raspbian has no installer, so how can I install it by
              starting with debootstrap? How it works with Debian can
              you find here: <a
                href="https://www.debian.org/releases/stable/i386/apds03.html.en"
                rel="noreferrer">install Debian with debootstrap</a> and
              the package can be found here: <a
href="http://mirrordirector.raspbian.org/raspbian/pool/main/d/debootstrap/"
                rel="noreferrer">debootstrap for Raspbian</a>.</p>
            <p>Is there anyone who knows how to fit this together?</p>
          </div>
          <div class="mb0 ">
            <div class="mt16 grid gs8 gsy fw-wrap jc-end ai-start pt4
              mb16"><a data-savepage-href="/posts/78232/revisions"
                href="https://raspberrypi.stackexchange.com/posts/78232/revisions"
                title="show all edits to this post" class="js-gps-track"
                data-gps-track="post.click({ item: 4, priv: 0,
                post_type: 1 })">edited <span title="2019-07-04
                  11:37:21Z" class="relativetime">Jul 4 '19 at 11:37</span></a>
              <div class="post-signature grid--cell">
                <div class="user-info ">
                  <div class="user-gravatar32"> </div>
                  <div class="user-details" itemprop="author"
                    itemscope="" itemtype="http://schema.org/Person">
                    <div class="-flair"> </div>
                  </div>
                </div>
              </div>
              <div class="post-signature owner grid--cell">
                <div class="user-info user-hover">
                  <div class="user-action-time"> asked <span
                      title="2018-01-23 21:13:22Z" class="relativetime">Jan
                      23 '18 at 21:13</span> </div>
                  <div class="user-gravatar32"> <a
                      data-savepage-href="/users/79866/ingo"
                      href="https://raspberrypi.stackexchange.com/users/79866/ingo">
                      <div class="gravatar-wrapper-32"><br>
                      </div>
                    </a> </div>
                  <div class="user-details" itemprop="author"
                    itemscope="" itemtype="http://schema.org/Person"> <a
                      data-savepage-href="/users/79866/ingo"
                      href="https://raspberrypi.stackexchange.com/users/79866/ingo">Ingo</a>
                    <div class="-flair"> <span class="reputation-score"
                        title="reputation score 35,566" dir="ltr">35.6k</span><span
                        title="12 gold badges" aria-hidden="true"><span
                          class="badge1"></span><span class="badgecount">12</span></span><span
                        class="v-visible-sr">12 gold badges</span><span
                        title="53 silver badges" aria-hidden="true"><span
                          class="badge2"></span><span class="badgecount">53</span></span><span
                        class="v-visible-sr">53 silver badges</span><span
                        title="149 bronze badges" aria-hidden="true"><span
                          class="badge3"></span><span class="badgecount">149</span></span><span
                        class="v-visible-sr">149 bronze badges</span> </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div id="answers">
          <div id="comments-78232" class="comments js-comments-container
            bt bc-black-075 mt12 " data-post-id="78232"
            data-min-length="15">
            <ul class="comments-list js-comments-list"
              data-remaining-comments-count="0" data-canpost="false"
              data-cansee="true" data-comments-unavailable="false"
              data-addlink-disabled="true">
              <li id="comment-123528" class="comment js-comment "
                data-comment-id="123528" data-comment-owner-id="56"
                data-comment-score="0">
                <div class="js-comment-actions comment-actions">
                  <div class="comment-score js-comment-edit-hide"> </div>
                </div>
                <div class="comment-text js-comment-text-and-form">
                  <div class="comment-body js-comment-edit-hide"> <span
                      class="comment-copy">Why can't you just burn an
                      image to the SD card?</span> –&nbsp;<a
                      data-savepage-href="/users/56/steve-robillard"
                      href="https://raspberrypi.stackexchange.com/users/56/steve-robillard"
                      title="33,037 reputation" class="comment-user">Steve
                      Robillard</a> <span class="comment-date"
                      dir="ltr"><a class="comment-link"
href="file:///C:/Users/vpanini/Downloads/software%20installation%20-%20Install%20base%20Raspbian%20from%20repository,%20not%20using%20an%20image%20-%20Raspberry%20Pi%20Stack%20Exchange.html#comment123528_78232"><span
                          title="2018-01-23 21:29:39Z, License: CC BY-SA
                          3.0" class="relativetime-clean">Jan 23 '18 at
                          21:29</span></a></span> </div>
                </div>
              </li>
              <li id="comment-123533" class="comment js-comment "
                data-comment-id="123533" data-comment-owner-id="79866"
                data-comment-score="3">
                <div class="js-comment-actions comment-actions">
                  <div class="comment-body js-comment-edit-hide"> <span
                      title="number of 'useful comment' votes received"
                      class="cool">3</span><span class="comment-copy">@SteveRobillard
                      I want a bare image only with debootstrap for
                      testing and development, so I can increase my
                      installation step by step by installing needed
                      packages. Do you know such an image?</span>
                    –&nbsp;<a data-savepage-href="/users/79866/ingo"
                      href="https://raspberrypi.stackexchange.com/users/79866/ingo"
                      title="35,566 reputation" class="comment-user
                      owner">Ingo</a> <span class="comment-date"
                      dir="ltr"><a class="comment-link"
href="file:///C:/Users/vpanini/Downloads/software%20installation%20-%20Install%20base%20Raspbian%20from%20repository,%20not%20using%20an%20image%20-%20Raspberry%20Pi%20Stack%20Exchange.html#comment123533_78232"><span
                          title="2018-01-23 22:00:43Z, License: CC BY-SA
                          3.0" class="relativetime-clean">Jan 23 '18 at
                          22:00</span></a></span> </div>
                </div>
                <div class="comment-text js-comment-text-and-form"> </div>
              </li>
            </ul>
          </div>
          2 Answers
          <div id="answers-header">
            <div class="answers-subheader grid ai-center mb8">
              <div class="grid--cell fl1"> </div>
              <div class="grid--cell">
                <div class=" grid s-btn-group js-filter-btn"> </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="answer-78287" class="answer" data-answerid="78287"
      data-ownerid="79866" data-score="7" itemprop="suggestedAnswer"
      itemscope="" itemtype="https://schema.org/Answer">
      <div class="post-layout">
        <div class="votecell post-layout--left">
          <div class="js-voting-container grid jc-center fd-column
            ai-stretch gs4 fc-black-200" data-post-id="78287">
          </div>
        </div>
        <div class="answercell post-layout--right">
          <div class="s-prose js-post-body" itemprop="text">
            <h1>━━━ Setup using a Linux computer with intel processor
              ━━━</h1>
            <p>This installation uses another computer with an intel
              processor. If you want to run the installation on a
              Raspberry Pi then look at the other answer here: <a
                href="https://raspberrypi.stackexchange.com/a/100192/79866">Installation
                using a Raspberry Pi</a>. If possible, I recommend that
              installation.</p>
            <p>We have to run <em>debootstrap</em> with an <code>armhf</code>
              architecture on a PC with intel processor. This is only
              possible with an emulator. <em>Qemu</em> is a program
              that can do this. So we have to install that together with
              <em>debootstrap</em> and additional needed packet <em>binfmt-support</em>
              <sup><a
href="https://wiki.debian.org/EmDebian/CrossDebootstrap#QEMU.2Fdebootstrap_approach"
                  rel="noreferrer"><strong>1</strong></a></sup>. I use <em>Debian
                GNU/Linux 9.4 (stretch) arch x86_64</em>. Others that
              have <em>debootstrap</em> and <em>qemu</em> should also
              work:</p>
            <pre class="lang-sh s-code-block hljs bash"><code>pc ~$ sudo apt install binfmt-support qemu qemu-user-static debootstrap
</code></pre>
            <p>We also need the <em>raspbian.public.key</em> to check
              integrety of the raspbian repository. So we download and
              import it into the apt keyring <code>/etc/apt/trusted.gpg</code>
              <sup><strong>2</strong></sup>:</p>
            <pre class="lang-sh s-code-block hljs bash"><code>pc ~$ wget http://archive.raspbian.org/raspbian.public.key -O - | sudo apt-key add -q
</code></pre>
            <p>Now we prepare the SD Card we want to install the
              bootstraped Raspbian. For reference I use <a
                href="https://www.raspberrypi.org/downloads/raspbian/"
                rel="noreferrer">Raspbian Stretch Light 2018-06-27</a>.
              Download and flash it to the SD Card. Start it with your
              RasPi, login and poweroff. This seems to be necessary to
              intitalize default boot sequence.</p>
            <p>Then put it into the card reader on the PC. For my
              example it is attached to <code>/dev/sdb</code>. Format
              the second partition with <em>ext4</em> and mount that
              partition:</p>
            <pre class="lang-sh s-code-block hljs bash"><code>pc ~$ sudo -Es
pc ~<span class="hljs-comment"># mkfs.ext4 -FL rootfs /dev/sdb2</span>
pc ~<span class="hljs-comment"># mkdir /mnt/sdb2</span>
pc ~<span class="hljs-comment"># mount /dev/sdb2 /mnt/sdb2</span>
</code></pre>
            <p>Now we install a basic Raspbian from <em>debootstrap</em>
              with <em>Qemu</em>:</p>
            <pre class="lang-sh s-code-block hljs bash"><code>pc ~<span class="hljs-comment"># qemu-debootstrap --keyring=/etc/apt/trusted.gpg --arch armhf stretch /mnt/sdb2/ http://mirrordirector.raspbian.org/raspbian/</span>
</code></pre>
            <p>When finished prepare installation for booting. We have
              to create a <em>fstab</em>:</p>
            <pre class="lang-sh s-code-block hljs bash"><code>pc ~<span class="hljs-comment"># cat &gt; /mnt/sdb2/etc/fstab &lt;&lt;EOF</span>
proc            /proc           proc    defaults          0       0
/dev/mmcblk0p1  /boot           vfat    defaults          0       2
/dev/mmcblk0p2  /               ext4    defaults,noatime  0       1
EOF
</code></pre>
            <p>Clear root password for first login. <strong>DON'T
                FORGET</strong> to set a password
              immediately after first login into the new pibootstrap!</p>
            <pre class="lang-sh s-code-block hljs bash"><code>pc ~<span class="hljs-comment"># sed -i 's/^root:x:/root::/' /mnt/sdb2/etc/passwd</span>
pc ~<span class="hljs-comment"># sed -i 's/^root:*:.*$/root::::/' /mnt/sdb2/etc/shadow</span>

pc ~<span class="hljs-comment"># umount /dev/sdb2</span>
pc ~<span class="hljs-comment"># e2fsck -f /dev/sdb2</span>
pc ~<span class="hljs-comment"># exit</span>
pc ~$
</code></pre>
            <p>Put the SD Card in the RasPi and boot.</p>
            <p>We have a clean tiny but working Raspbian consuming just
              276 MB of
              diskspace. This is a good startpoint to build clear test
              environments or
              to learn how it works step by step. Maybe you will first
              make an account
              for a normal user and configure network connection, so you
              can use <code>apt</code>
              to install software packages.</p>
            <h2>Setup basic Raspbian for systemd</h2>
            <p>Login as root without password. Then excute:</p>
            <pre class="lang-sh s-code-block hljs bash"><code>rpi ~<span class="hljs-comment"># passwd</span>
</code></pre>
            <p>Then do:</p>
            <pre class="lang-sh s-code-block hljs bash"><code>rpi ~<span class="hljs-comment"># mkdir -p /var/log/journal</span>
rpi ~<span class="hljs-comment"># systemd-tmpfiles --create --prefix=/var/log/journal # ignore warning</span>

rpi ~<span class="hljs-comment"># apt --autoremove purge ifupdown</span>
rpi ~<span class="hljs-comment"># cat &gt; /etc/systemd/network/04-eth.network &lt;&lt;EOF</span>
[Match]
Name=e*
[Network]
DHCP=yes
EOF

rpi ~<span class="hljs-comment"># systemctl enable systemd-networkd.service</span>
rpi ~<span class="hljs-comment"># systemctl enable systemd-resolved.service</span>
rpi ~<span class="hljs-comment"># ln -sf /run/systemd/resolve/resolv.conf /etc/resolv.conf</span>
rpi ~<span class="hljs-comment"># systemctl start systemd-networkd.service</span>
rpi ~<span class="hljs-comment"># systemctl start systemd-resolved.service</span>
</code></pre>
            <p>Copy <code>/etc/apt/sources.list</code> and <code>/etc/apt/sources.list.d/raspi.list</code>
              from a default Raspbian installation. Then:</p>
            <pre class="lang-sh s-code-block hljs bash"><code>rpi ~<span class="hljs-comment"># echo 'APT::InstallRecommends "false";' &gt; /etc/apt/apt.conf.d/99install-recommends</span>
rpi ~<span class="hljs-comment"># apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 8B48AD6246925553</span>
rpi ~<span class="hljs-comment"># apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 7638D0442B90D010</span>
rpi ~<span class="hljs-comment"># apt update</span>
rpi ~<span class="hljs-comment"># apt install dirmngr</span>
rpi ~<span class="hljs-comment"># apt full-upgrade</span>

rpi ~<span class="hljs-comment"># apt install libraspberrypi-bin raspberrypi-kernel raspberrypi-sys-mods</span>
rpi ~<span class="hljs-comment"># apt install sudo bash-completion lvm2 dbus firmware-brcm80211 </span>
rpi ~<span class="hljs-comment"># adduser pi</span>
rpi ~<span class="hljs-comment"># useradd --groups sudo,adm pi</span>

add to sudoers:
<span class="hljs-comment"># Allow members of group sudo to execute any command</span>
%sudo   ALL=(ALL:ALL) NOPASSWD: ALL

rpi ~<span class="hljs-comment"># #change hostname</span>
rpi ~<span class="hljs-comment"># sed -i 's/.*/raspberrypi/' /etc/hostname</span>
rpi ~<span class="hljs-comment"># echo "127.0.1.1       raspberrypi" &gt;&gt; /etc/hosts</span>
</code></pre>
            <p>Reboot.</p>
            <p><br>
              <strong>references:</strong><br>
              [1] <a
href="https://wiki.debian.org/EmDebian/CrossDebootstrap#QEMU.2Fdebootstrap_approach"
                rel="noreferrer">EmDebian CrossDebootstrap</a><br>
              [2] man apt-key<br>
              [3] man debootstrap</p>
          </div>
          <div class="mt24">
            <div class="grid fw-wrap ai-start jc-end gs8 gsy"> <time
                itemprop="dateCreated" datetime="2018-01-25T01:14:19"></time>
              <div class="grid--cell mr16" style="flex: 1 1 100px;">
                <div class="js-post-menu pt2" data-post-id="78287">
                  <div class="grid d-flex gs8 s-anchors s-anchors__muted
                    fw-wrap"><br>
                  </div>
                </div>
              </div>
              <div class="post-signature grid--cell fl0">
                <div class="user-info ">
                  <div class="user-action-time"> <a
                      data-savepage-href="/posts/78287/revisions"
                      href="https://raspberrypi.stackexchange.com/posts/78287/revisions"
                      title="show all edits to this post"
                      class="js-gps-track" data-gps-track="post.click({
                      item: 4, priv: 0, post_type: 2 })">edited <span
                        title="2019-07-11 11:57:45Z"
                        class="relativetime">Jul 11 '19 at 11:57</span></a>
                  </div>
                  <div class="user-gravatar32"> </div>
                  <div class="user-details">
                    <div class="-flair"> </div>
                  </div>
                </div>
              </div>
              <div class="post-signature owner grid--cell fl0">
                <div class="user-info user-hover">
                  <div class="user-action-time"> answered <span
                      title="2018-01-25 01:14:19Z" class="relativetime">Jan
                      25 '18 at 1:14</span> </div>
                  <div class="user-gravatar32"> <a
                      data-savepage-href="/users/79866/ingo"
                      href="https://raspberrypi.stackexchange.com/users/79866/ingo">
                      <div class="gravatar-wrapper-32"><br>
                      </div>
                    </a> </div>
                  <div class="user-details" itemprop="author"
                    itemscope="" itemtype="http://schema.org/Person"> <a
                      data-savepage-href="/users/79866/ingo"
                      href="https://raspberrypi.stackexchange.com/users/79866/ingo">Ingo</a>
                    <div class="-flair"> <span class="reputation-score"
                        title="reputation score 35,566" dir="ltr">35.6k</span><span
                        title="12 gold badges" aria-hidden="true"><span
                          class="badge1"></span><span class="badgecount">12</span></span><span
                        class="v-visible-sr">12 gold badges</span><span
                        title="53 silver badges" aria-hidden="true"><span
                          class="badge2"></span><span class="badgecount">53</span></span><span
                        class="v-visible-sr">53 silver badges</span><span
                        title="149 bronze badges" aria-hidden="true"><span
                          class="badge3"></span><span class="badgecount">149</span></span><span
                        class="v-visible-sr">149 bronze badges</span> </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="post-layout--right js-post-comments-component">
          <div id="comments-link-78287" data-rep="50" data-anon="true">
            <a class="js-add-link comments-link disabled-link"
              title="Use comments to ask for more information or suggest
              improvements. Avoid comments like “+1” or “thanks”."
href="file:///C:/Users/vpanini/Downloads/software%20installation%20-%20Install%20base%20Raspbian%20from%20repository,%20not%20using%20an%20image%20-%20Raspberry%20Pi%20Stack%20Exchange.html#"
              role="button">Add a comment</a> </div>
        </div>
      </div>
    </div>
    <div class="js-zone-container zone-container-main"> </div>
    <br>
    <div class="answercell post-layout--right">
      <div class="s-prose js-post-body" itemprop="text">
        <h1>━━━ Installation using a Raspberry Pi ━━━</h1>
        <p>This installation uses a Raspberry Pi for setup. If you want
          to use another computer then look at the other answer here: <a
            href="https://raspberrypi.stackexchange.com/a/78287/79866">Setup
            using a Linux computer with intel processor</a>.</p>
        <p>You need two SD Cards, one to boot the RasPi and one attached
          with your SD Card reader on an USB port of the RasPi. I will
          try to present two installation paths because they are similar
          and have many common setups. First I will install Raspbian on
          two primary partitions as it is done on the default image <a
            href="https://www.raspberrypi.org/downloads/raspbian/"
            rel="nofollow noreferrer">Raspbian Buster</a>. This is less
          error prone for newbies or to get quick a running system. On
          the other path I will use logical volumes because I love to
          use its nice features for easy backup, restore from snapshots,
          desaster recovery and others. I labled the setups with COMMON,
          PRIMPART (primary partitions) and LVM. If you want to use
          primary partitions just follow only parts labled with COMMON
          and PRIMPART, ignore parts with LVM. Installing logical
          volumes only use COMMON and LVM.</p>
        <p>I will partition and format a virgin SD Card so I'm able to
          configure it to just what I like. First I prepare the master
          boot record (MBR), then partition the SD Card and format it. I
          will do it on the Raspberry Pi so we do not have problems
          running software for the ARM processor to be used for
          installation and we can chroot into the new installation and
          prepare needed things. it is recommended to use an up to date
          Raspbian version to start the RasPi for installation because
          we copy some configuration files. For reference I use <a
            href="https://www.raspberrypi.org/downloads/raspbian/"
            rel="nofollow noreferrer">Raspbian Buster Lite</a> udated
          with <code>sudo apt update &amp;&amp; sudo apt full-upgrade
            &amp;&amp; sudo reboot</code>. I assume you have the
          internet connection already running.</p>
        <hr>
        <p><strong>COMMON</strong>:<br>
          Boot the RasPi and after login create a default msdos
          partition table on the empty SD Card. I assume it is attached
          to <code>/dev/sda</code>:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>rpi ~$ sudo -Es
rpi ~<span class="hljs-comment"># parted /dev/sda mktable msdos</span>
</code></pre>
        <p>Now we have made a master boot record (MBR), the very first
          sector with 512 bytes. It also contains a very small boot
          sequence at the beginning. You can check it with:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>rpi ~<span class="hljs-comment"># hd -v -n512 /dev/sda</span>
</code></pre>
        <p>Partition the SD Card with sizes what you like. I will use a
          16 GB card:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>rpi ~<span class="hljs-comment"># parted /dev/sda mkpart primary fat32 8192s 132MB</span>
rpi ~<span class="hljs-comment"># parted /dev/sda mkpart primary 132MB 100%</span>
</code></pre>
        <p>The boot sequence in the MBR is not used by a Raspberry Pi so
          we will delete it with:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>rpi ~<span class="hljs-comment"># dd if=/dev/zero of=/dev/sda bs=1 count=440 conv=notrunc</span>
</code></pre>
        <p>This is not really required but I do it to be on the save
          side because the MBR from the original Raspbian image is also
          nullified on this sequence. Then we format the first partition
          with <strong>fat32</strong> and make a mount point.</p>
        <pre class="lang-sh s-code-block hljs bash"><code>rpi ~<span class="hljs-comment"># mkfs.vfat -vF 32 -n BOOT /dev/sda1</span>
rpi ~<span class="hljs-comment"># mkdir /mnt/p2</span>
</code></pre>
        <hr>
        <p><strong>PRIMPART</strong>:<br>
          Format the second partition with <strong>ext4</strong> and
          mount it:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>rpi ~<span class="hljs-comment"># mkfs.ext4 -vL rootfs /dev/sda2</span>
rpi ~<span class="hljs-comment"># mount /dev/sda2 /mnt/p2</span>
</code></pre>
        <hr>
        <p><strong>LVM</strong>:<br>
          Setup logical volumes in the second partition, format it with
          <strong>ext4</strong> and mount it:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>rpi ~<span class="hljs-comment"># parted /dev/sda set 2 lvm on</span>
rpi ~<span class="hljs-comment"># pvcreate /dev/sda2  # define physical volume</span>
rpi ~<span class="hljs-comment"># vgcreate rpi_vg /dev/sda2  # create volume group using physical volume</span>
rpi ~<span class="hljs-comment"># lvcreate rpi_vg --name root_lv --size 8G  # create logical volume in volume group</span>

<span class="hljs-comment"># format the logical volume and mount it</span>
rpi ~<span class="hljs-comment"># mkfs.ext4 -vL rootfs /dev/mapper/rpi_vg-root_lv</span>
rpi ~<span class="hljs-comment"># mount /dev/mapper/rpi_vg-root_lv /mnt/p2</span>
</code></pre>
        <hr>
        <p><strong>COMMON</strong>:<br>
          Mount the boot partition:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>rpi ~<span class="hljs-comment"># mkdir /mnt/p2/boot</span>
rpi ~<span class="hljs-comment"># mount /dev/sda1 /mnt/p2/boot/</span>
</code></pre>
        <p>We install the debootstrap installation program and execute
          it:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>rpi ~<span class="hljs-comment"># apt install debootstrap</span>
rpi ~<span class="hljs-comment"># /usr/sbin/debootstrap --arch armhf buster /mnt/p2 http://raspbian.raspberrypi.org/raspbian</span>
</code></pre>
        <p>Now we have a tiny but complete Debian/Raspbian operating
          system on the new SD Card. We have to do some essential
          setups. Copy the default repository sources list files:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>rpi ~<span class="hljs-comment"># cp /etc/apt/sources.list /mnt/p2/etc/apt/</span>
rpi ~<span class="hljs-comment"># cp /etc/apt/sources.list.d/raspi.list /mnt/p2/etc/apt/sources.list.d/</span>
</code></pre>
        <hr>
        <p><strong>PRIMPART:</strong><br>
          First set the kernel boot parameter with <code>boot/cmdline.txt</code>:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>rpi ~<span class="hljs-comment"># echo 'console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait' &gt; /mnt/p2/boot/cmdline.txt</span>
</code></pre>
        <p>You can use <code>console=serial0,115200</code> instead of <code>console=tty1</code>
          if you are using the serial debug console like me. If you
          don't like <a
href="https://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/"
            rel="nofollow noreferrer">Predictable Network Interface
            Names</a> you can append <code>net.ifnames=0</code> to
          cmdline.txt. To make the new SD Card bootable we have to set <code>/etc/fstab</code>:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>rpi ~<span class="hljs-comment"># cat &gt; /mnt/p2/etc/fstab &lt;&lt;EOF</span>
/dev/mmcblk0p1  /boot    vfat    defaults            0    2
/dev/mmcblk0p2  /        ext4    defaults,noatime    0    1
EOF
</code></pre>
        <hr>
        <p><strong>LVM:</strong><br>
          First set the kernel boot parameter with <code>boot/cmdline.txt</code>:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>rpi ~<span class="hljs-comment"># echo 'console=tty1 root=/dev/mapper/rpi_vg-root_lv rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait' &gt; /mnt/p2/boot/cmdline.txt</span>
</code></pre>
        <p>You can use <code>console=serial0,115200</code> instead of <code>console=tty1</code>
          if you are using the serial debug console like me. If you
          don't like <a
href="https://www.freedesktop.org/wiki/Software/systemd/PredictableNetworkInterfaceNames/"
            rel="nofollow noreferrer">Predictable Network Interface
            Names</a> you can append <code>net.ifnames=0</code> to
          cmdline.txt. To make the new SD Card bootable we have to set <code>/etc/fstab</code>:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>rpi ~<span class="hljs-comment"># cat &gt; /mnt/p2/etc/fstab &lt;&lt;EOF</span>
/dev/mmcblk0p1                /boot    vfat    defaults            0    2
/dev/mapper/rpi_vg-root_lv    /        ext4    defaults,noatime    0    1
EOF
</code></pre>
        <hr>
        <p><strong>COMMON:</strong><br>
          Now we chroot into the new tiny installation and install the
          kernel and firmware:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>rpi -<span class="hljs-comment"># mount --bind /dev/pts /mnt/p2/dev/pts</span>
rpi ~<span class="hljs-comment"># LANG=C.UTF-8 chroot /mnt/p2 /bin/bash</span>
root@raspberrypi:/<span class="hljs-comment"># export TERM=linux</span>
</code></pre>
        <p>apt claims a signing key so we have to get it first:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>root@raspberrypi:/<span class="hljs-comment"># apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 82B129927FA3303E</span>
</code></pre>
        <p>The only user on the new installation is root but its
          password isn't set, so we will not be able to log in after
          booting the new SD Card. So first set the root password:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>root@raspberrypi:/<span class="hljs-comment"># passwd root</span>
</code></pre>
        <p>Now we install the kernel and firmware:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>root@raspberrypi:/<span class="hljs-comment"># apt install dialog</span>
root@raspberrypi:/<span class="hljs-comment"># apt update</span>
root@raspberrypi:/<span class="hljs-comment"># apt full-upgrade</span>
root@raspberrypi:/<span class="hljs-comment"># echo raspi4 &gt; /etc/hostname  # or what you want to name your RasPi</span>
root@raspberrypi:/<span class="hljs-comment"># apt install raspberrypi-bootloader</span>
root@raspberrypi:/<span class="hljs-comment"># apt install libraspberrypi-bin</span>
root@raspberrypi:/<span class="hljs-comment"># apt install raspberrypi-archive-keyring raspberrypi-sys-mods</span>
root@raspberrypi:/<span class="hljs-comment"># apt install sudo</span>
<span class="hljs-comment"># WiFi driver</span>
root@raspberrypi:/<span class="hljs-comment"># apt install --no-install-recommends firmware-brcm80211 wireless-regdb crda</span>
</code></pre>
        <p>Only if you want to use the serial debug console, like me,
          then enable it:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>root@raspberrypy:/<span class="hljs-comment"># echo 'enable_uart=1' &gt;&gt; /boot/config.txt</span>
</code></pre>
        <hr>
        <p><strong>PRIMPART:</strong><br>
          Exit chroot:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>root@raspberrypi:/<span class="hljs-comment"># exit</span>
rpi ~<span class="hljs-comment">#</span>
</code></pre>
        <hr>
        <p><strong>LVM:</strong><br>
          For the lvm we need to load the driver on early stage boot to
          be able to access the root volume. So we have to use an init
          ramdisk and install lvm driver:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>root@raspberrypi:/<span class="hljs-comment"># apt install initramfs-tools</span>
root@raspberrypi:/<span class="hljs-comment"># apt install lvm2</span>

<span class="hljs-comment"># I only want to load listed modules</span>
root@raspberrypi:/<span class="hljs-comment"># sed -i 's/^MODULES=most/MODULES=list/' /etc/initramfs-tools/initramfs.conf</span>
</code></pre>
        <p>In <code>/boot/config.txt</code> define to load the ramdisk
          depending on the Raspberry Pi version. First look what modules
          have to be loaded, for example:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>root@Raspberrypi:/<span class="hljs-comment"># ls /lib/modules</span>
4.19.97+  4.19.97-v7+  4.19.97-v7l+  4.19.97-v8+
</code></pre>
        <p>Then at the top of <code>/boot/config.txt</code> insert
          these lines:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>[pi3]
initramfs initrd.img-4.19.97-v7+ followkernel
[pi4]
initramfs initrd.img-4.19.97-v7l+ followkernel
<span class="hljs-comment"># arm_64bit=1</span>
<span class="hljs-comment"># initramfs initrd.img-4.19.97-v8+ followkernel</span>
[all]
</code></pre>
        <p>Finally create the needed init ramdisks and exit chroot. You
          can ignore warnings:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>root@Raspberrypi:/<span class="hljs-comment"># mkinitramfs -o /boot/initrd.img-4.19.97-v7+ 4.19.97-v7+</span>
root@Raspberrypi:/<span class="hljs-comment"># mkinitramfs -o /boot/initrd.img-4.19.97-v7l+ 4.19.97-v7l+</span>
root@raspberrypi:/<span class="hljs-comment"># exit</span>
rpi ~<span class="hljs-comment">#</span>
</code></pre>
        <p>Don't forget to update the ramdisk version and recreate it if
          you update kernel or firmware, otherwise it may be possible
          that you cannot boot anymore. But then you can mount the SD
          Card to your RasPi like this, chroot into it and recreate the
          ramdisk.</p>
        <hr>
        <p><strong>COMMON:</strong><br>
          Clean up and poweroff:</p>
        <pre class="lang-sh s-code-block hljs bash"><code>rpi ~<span class="hljs-comment"># </span>
rpi ~<span class="hljs-comment"># umount /mnt/p2/boot</span>
rpi ~<span class="hljs-comment"># umount /mnt/p2/dev/pts</span>
rpi ~<span class="hljs-comment"># umount /mnt/p2</span>
rpi ~<span class="hljs-comment"># rmdir /mnt/p2</span>
rpi ~<span class="hljs-comment"># systemctl poweroff</span>
</code></pre>
        <p>Now change the SD Card and boot the new installation. Login
          with root.</p>
        <p>We have a clean tiny but working Raspbian with usable <strong>apt</strong>
          package manager. It consumes just 356 MB of diskspace for the
          root partition. This is a good starting point to build custom
          environments or to learn how it works step by step. Maybe you
          will first make an account for a normal user and configure
          network connection, so you can use apt to install software
          packages.</p>
        <p><br>
          <strong>references:</strong><br>
          (1) <a
            href="https://raspberrypi.stackexchange.com/q/78466/79866">How
            to make an image file from scratch</a><br>
          (2) <a
            href="https://raspberrypi.stackexchange.com/q/85958/79866">Easy
            backups and snapshots of a running system with LVM</a></p>
      </div>
      <div class="mt24">
        <div class="grid fw-wrap ai-start jc-end gs8 gsy"> <time
            itemprop="dateCreated" datetime="2019-07-01T20:43:59"></time>
          <div class="grid--cell mr16" style="flex: 1 1 100px;">
            <div class="js-post-menu pt2" data-post-id="100192">
              <div class="grid d-flex gs8 s-anchors s-anchors__muted
                fw-wrap"><br>
                <div class="grid--cell"> <br>
                </div>
              </div>
            </div>
          </div>
          <div class="post-signature grid--cell fl0">
            <div class="user-info ">
              <div class="user-action-time"> <a
                  data-savepage-href="/posts/100192/revisions"
                  href="https://raspberrypi.stackexchange.com/posts/100192/revisions"
                  title="show all edits to this post"
                  class="js-gps-track" data-gps-track="post.click({
                  item: 4, priv: 0, post_type: 2 })">edited <span
                    title="2020-05-11 16:28:42Z" class="relativetime">May
                    11 '20 at 16:28</span></a> </div>
              <div class="user-gravatar32"> </div>
              <div class="user-details">
                <div class="-flair"> </div>
              </div>
            </div>
          </div>
          <div class="post-signature owner grid--cell fl0">
            <div class="user-info user-hover">
              <div class="user-action-time"> answered <span
                  title="2019-07-01 20:43:59Z" class="relativetime">Jul
                  1 '19 at 20:43</span> </div>
              <div class="user-gravatar32"> <a
                  data-savepage-href="/users/79866/ingo"
                  href="https://raspberrypi.stackexchange.com/users/79866/ingo">
                  <div class="gravatar-wrapper-32"><br>
                  </div>
                </a> </div>
              <div class="user-details" itemprop="author" itemscope=""
                itemtype="http://schema.org/Person"> <a
                  data-savepage-href="/users/79866/ingo"
                  href="https://raspberrypi.stackexchange.com/users/79866/ingo">Ingo</a>
                <div class="-flair"> <span class="reputation-score"
                    title="reputation score 35,566" dir="ltr">35.6k</span><span
                    title="12 gold badges" aria-hidden="true"><span
                      class="badge1"></span><span class="badgecount">12</span></span><span
                    class="v-visible-sr">12 gold badges</span><span
                    title="53 silver badges" aria-hidden="true"><span
                      class="badge2"></span><span class="badgecount">53</span></span><span
                    class="v-visible-sr">53 silver badges</span><span
                    title="149 bronze badges" aria-hidden="true"><span
                      class="badge3"></span><span class="badgecount">149</span></span><span
                    class="v-visible-sr">149 bronze badges</span> </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="comments-100192" class="comments js-comments-container bt
      bc-black-075 mt12 " data-post-id="100192" data-min-length="15">
      <ul class="comments-list js-comments-list"
        data-remaining-comments-count="0" data-canpost="false"
        data-cansee="true" data-comments-unavailable="false"
        data-addlink-disabled="true">
        <li id="comment-184967" class="comment js-comment "
          data-comment-id="184967" data-comment-owner-id="26190"
          data-comment-score="0">
          <div class="js-comment-actions comment-actions">
            <div class="comment-score js-comment-edit-hide"> </div>
          </div>
          <div class="comment-text js-comment-text-and-form">
            <div class="comment-body js-comment-edit-hide"> <span
                class="comment-copy">Very useful reference. Thanks. <code>MODULES=list</code>is
                PITA because you need to explicilty configure the module
                list -- not for the faint hearted. In the end I just ran
                <code>mkinitramfs</code> on my clean Rasbian install
                then cloned the SD root FS into the LV copy with a <code>sudo
                  rsync -ax / /mnt/newroot</code>, updated <code>/boot/cmdline.txt</code>
                to point to the new mapped copy and hey presto. Now I've
                got my VG and LVs on my Z3 SSD.</span> –&nbsp;<a
                data-savepage-href="/users/26190/terrye"
                href="https://raspberrypi.stackexchange.com/users/26190/terrye"
                title="101 reputation" class="comment-user">TerryE</a> <span
                class="comment-date" dir="ltr"><a class="comment-link"
href="file:///C:/Users/vpanini/Downloads/software%20installation%20-%20Install%20base%20Raspbian%20from%20repository,%20not%20using%20an%20image%20-%20Raspberry%20Pi%20Stack%20Exchange.html#comment184967_100192"><span
                    title="2020-02-19 23:59:51Z, License: CC BY-SA 4.0"
                    class="relativetime-clean">Feb 19 '20 at 23:59</span></a></span>
            </div>
          </div>
        </li>
        <li id="comment-184968" class="comment js-comment "
          data-comment-id="184968" data-comment-owner-id="79866"
          data-comment-score="1">
          <div class="js-comment-actions comment-actions">
            <div class="comment-score js-comment-edit-hide"> <span
                title="number of 'useful comment' votes received"
                class="cool">1</span> </div>
          </div>
          <div class="comment-text js-comment-text-and-form">
            <div class="comment-body js-comment-edit-hide"> <span
                class="comment-copy">@TerryE Is it worth an upvote? ;-)</span>
              –&nbsp;<a data-savepage-href="/users/79866/ingo"
                href="https://raspberrypi.stackexchange.com/users/79866/ingo"
                title="35,566 reputation" class="comment-user owner">Ingo</a>
              <span class="comment-date" dir="ltr"><a
                  class="comment-link"
href="file:///C:/Users/vpanini/Downloads/software%20installation%20-%20Install%20base%20Raspbian%20from%20repository,%20not%20using%20an%20image%20-%20Raspberry%20Pi%20Stack%20Exchange.html#comment184968_100192"><span
                    title="2020-02-20 00:16:08Z, License: CC BY-SA 4.0"
                    class="relativetime-clean">Feb 20 '20 at 0:16</span></a></span>
            </div>
          </div>
        </li>
        <li id="comment-184969" class="comment js-comment "
          data-comment-id="184969" data-comment-owner-id="26190"
          data-comment-score="0">
          <div class="js-comment-actions comment-actions">
            <div class="comment-score js-comment-edit-hide"> </div>
          </div>
          <div class="comment-text js-comment-text-and-form">
            <div class="comment-body js-comment-edit-hide"> <span
                class="comment-copy">You can have two ;-?</span> –&nbsp;<a
                data-savepage-href="/users/26190/terrye"
                href="https://raspberrypi.stackexchange.com/users/26190/terrye"
                title="101 reputation" class="comment-user">TerryE</a> <span
                class="comment-date" dir="ltr"><a class="comment-link"
href="file:///C:/Users/vpanini/Downloads/software%20installation%20-%20Install%20base%20Raspbian%20from%20repository,%20not%20using%20an%20image%20-%20Raspberry%20Pi%20Stack%20Exchange.html#comment184969_100192"><span
                    title="2020-02-20 00:18:36Z, License: CC BY-SA 4.0"
                    class="relativetime-clean">Feb 20 '20 at 0:18</span></a></span>
              <span title="this comment was edited 1 time">
                <svg aria-hidden="true" class="va-text-bottom o50
                  svg-icon iconPencilSm" width="14" height="14"
                  viewBox="0 0 14 14"></svg> </span> </div>
          </div>
        </li>
      </ul>
    </div>
  </body>
</html>
